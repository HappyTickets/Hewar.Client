<div class="container">
  <p-table [value]="securityOffers" dataKey="id" stripedRows [paginator]="true" [rows]="7" [globalFilterFields]="['name']" selectionMode="single" #id [tableStyle]="{'height': '50rem' }">
    <ng-template #caption>
      <p-iconfield iconPosition="left">
          <p-inputicon><i class="pi pi-search"></i></p-inputicon>
          <input pInputText type="text" [(ngModel)]="searchTerm" (input)="id.filterGlobal(searchTerm, 'contains')" placeholder="Global Search"/>
      </p-iconfield>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 5rem"></th>
        <th pSortableColumn="name">Client Name <p-sortIcon field="name"></p-sortIcon></th>
        <th pSortableColumn="servicesNames">Services <p-sortIcon field="servicesNames"></p-sortIcon></th>
        <th pSortableColumn="status">Offer Status <p-sortIcon field="status"></p-sortIcon></th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-offer let-expanded="expanded">
      <tr>
        <td><p-button type="button" [pRowToggler]="offer" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"/></td>
        <td>{{ offer.name }}</td>
        <td>{{ offer.servicesNames }}</td>
        <td>{{ offer.status }}</td>
        <td><p-button (click)="openChat()" label="Chat"/></td>
      </tr>
    </ng-template>

    <ng-template pTemplate="rowexpansion" let-offer class="p-2">
      <tr>
        <td colspan="5">
          <div class="flex justify-content-between mt-1">
            <div class="flex gap-2">Start Date: <strong>{{offer.startDate}}</strong></div>
            <div>End Date: <strong>{{offer.endDate}}</strong></div>
          </div>
        </td>
        </tr>
      <tr>
        <td colspan="5">
          <p-table [value]="offer.services" dataKey="id">
            <ng-template pTemplate="header">
              <tr>
                <th>Service Type</th>
                <th>Quantity</th>
                <th>Shift Type</th>
                <th>Monthly Cost</th>
                <th>Daily Cost</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-service>
              <tr>
                <td>{{ service.name }}</td>
                <td>{{ service.quantity }}</td>
                <td>{{ service.shiftType }}</td>
                <td>
                  @if (offer.isEditMode) {
                  <p-inputNumber [(ngModel)]="service.monthlyCost" [min]="0" [minFractionDigits]="0" [maxFractionDigits]="0" placeholder="Enter Monthly Cost" class="w-full"/>
                  } @else {
                    {{ service.monthlyCost }}
                  }
                </td>
                <td>
                  @if (offer.isEditMode) {
                  <p-inputNumber [(ngModel)]="service.dailyCost" [min]="0" [minFractionDigits]="0" [maxFractionDigits]="0" placeholder="Enter Daily Cost" class="w-full"/>
                  } @else {
                  {{ service.dailyCost }}
                  }
                </td>
              </tr>
            </ng-template>
          </p-table>
          <div class="flex justify-content-between mt-4">
            <div class="flex gap-2">
              @if (!offer.isEditMode) {
              <p-button label="Edit Offer" (click)="editOffer(offer)" />
              <p-button label="Delete" (click)="deleteOffer(offer)" />
              } @else {
              <div class="flex gap-4">
                <p-button label="Submit" (click)="submitOffer(offer)" [disabled]="isSubmitDisabled(offer)"/>
                <p-button label="Cancel" (click)="cancelEdit(offer)"/>
              </div>
              }
            </div>
            <div>
              @if (!offer.isEditMode) {
              <p-button label="Close" (click)="offer.expanded = false" />
              }
            </div>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
